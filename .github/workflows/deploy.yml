name: build

on:
    push:
        branches:
            - master

    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v2
      
#           - name: Use Node.js 14.15.3
#             uses: actions/setup-node@v1
#             with:
#               node-version: '14.15.3'
#
#           - name: Install npm and run unittest
#             run: |
#               npm install
#               npm run test
#             env:
#               CI: true

            -   name: Set up QEMU
                uses: docker/setup-qemu-action@v1

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v1

            -   name: Login to DockerHub
                uses: docker/login-action@v1
                with:
                    username: ${{ secrets.DOCKER_HUB_USERNAME }}
                    password: ${{ secrets.DOCKER_HUB_PASSWORD }}

            -   name: Build and push app
                id: docker_build_app
                uses: docker/build-push-action@v2
                with:
                    context: .
                    file: ./docker/app/Dockerfile
                    push: true
                    tags: iamkevinlowe/elastic-movies_app:latest

            -   name: Build and push worker
                id: docker_build_worker
                uses: docker/build-push-action@v2
                with:
                    context: .
                    file: ./docker/worker/Dockerfile
                    push: true
                    tags: iamkevinlowe/elastic-movies_worker:latest

            -   name: Build and push server
                id: docker_build_server
                uses: docker/build-push-action@v2
                with:
                    context: .
                    file: ./docker/server/Dockerfile
                    push: true
                    tags: iamkevinlowe/elastic-movies_server:latest

            -   name: Image digests
                run: |
                    echo "App: ${{ steps.docker_build_app.outputs.digest }}"
                    echo "Worker: ${{ steps.docker_build_worker.outputs.digest }}"
                    echo "Server: ${{ steps.docker_build_server.outputs.digest }}"

            -   name: Deploy to Digitalocean
                uses: appleboy/ssh-action@master
                env:
                    DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
                    DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
                with:
                    host: ${{ secrets.DO_IP_ADDRESS }}
                    username: ${{ secrets.DO_USERNAME }}
                    key: ${{ secrets.DO_KEY }}
                    port: ${{ secrets.DO_PORT }}
                    envs: DOCKER_HUB_USERNAME, DOCKER_HUB_PASSWORD
                    script: |
                        docker stop $(docker ps -a -q)
                        docker rm $(docker ps -a -q)
                        docker network rm elastic-movies_network
                        docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
                        docker pull iamkevinlowe/elastic-movies_app:latest
                        docker pull iamkevinlowe/elastic-movies_worker:latest
                        docker pull iamkevinlowe/elastic-movies_server:latest
                        docker pull redis:latest
                        docker pull certbot/certbot:latest
                        docker network create elastic-movies_network
                        docker run -d -h redis --name elastic-movies_redis --network elastic-movies_network --restart on-failure -v data_redis:/data redis:latest
                        docker run -d --env-file env/app.env -h app --name elastic-movies_app --network elastic-movies_network --restart on-failure -v web-root:/usr/src/app/dist iamkevinlowe/elastic-movies_app:latest
                        docker run -d --env-file env/worker.env --name elastic-movies_worker --network elastic-movies_network -p 9000:9000 --restart on-failure iamkevinlowe/elastic-movies_worker:latest
                        docker run -d --name elastic-movies_server --network elstic-movies_network -p 80:80 --restart unless-stopped -v web-root:/var/www/html -v certbot-etc:/etc/letsencrypt -v certbot-var:/var/lib/letsencrypt nginx:mainline-alpine
                        docker run -d --rm --name elastic-movies_certbot -v certbot-etc:/etc/letsencrypt -v certbot-var:/var/lib/letsencrypt -v web-root:/var/www/html certbot/certbot certonly --webroot --webroot-path=/var/www/html --email iamkevinlowe@gmail.com --agree-tos --no-eff-email --staging -d elastic-movies.com -d www.elastic-movies.com
