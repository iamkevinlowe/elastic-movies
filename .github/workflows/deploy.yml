name: build

on:
    push:
        branches:
            - master

    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v2
      
#           - name: Use Node.js 14.15.3
#             uses: actions/setup-node@v1
#             with:
#               node-version: '14.15.3'
#
#           - name: Install npm and run unittest
#             run: |
#               npm install
#               npm run test
#             env:
#               CI: true

            -   name: Set up QEMU
                uses: docker/setup-qemu-action@v1

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v1

            -   name: Login to DockerHub
                uses: docker/login-action@v1
                with:
                    username: ${{ secrets.DOCKER_HUB_USERNAME }}
                    password: ${{ secrets.DOCKER_HUB_PASSWORD }}

            -   name: Build and push app
                id: docker_build_app
                uses: docker/build-push-action@v2
                with:
                    context: .
                    file: ./docker/app/Dockerfile
                    push: true
                    tags: iamkevinlowe/elastic-movies_app:latest


            -   name: Build and push worker
                id: docker_build_worker
                uses: docker/build-push-action@v2
                with:
                    context: .
                    file: ./docker/worker/Dockerfile
                    push: true
                    tags: iamkevinlowe/elastic-movies_worker:latest

            -   name: Deploy package to digitalocean
                uses: appleboy/ssh-action@master
                env:
                    DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
                    DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
                with:
                    host: ${{ secrets.DO_IP_ADDRESS }}
                    username: ${{ secrets.DO_USERNAME }}
                    password: ${{ secrets.DO_PASSWORD }}
                    port: ${{ secrets.DO_PORT }}
                    envs: DOCKER_HUB_USERNAME, DOCKER_HUB_PASSWORD
                    script: |
                        docker stop $(docker ps -a -q)
                        docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
                        docker pull iamkevinlowe/elastic-movies_app:latest
                        docker run -dit -p 80:80 iamkevinlowe/elastic-movies_app:latest

            -   name: Image digests
                run: |
                    echo ${{ steps.docker_build_app.outputs.digest }}
                    echo ${{ steps.docker_build_worker.outputs.digest }}
